---
layout: post
title: Unity资源管理模块
---

今天写了一天的资源管理模块，决定记录一下。

首先，为什么要单独写一个Unity资源管理模块？很多设计在思考的时候确实很美好，感觉完美无瑕，但是当真正放入项目中后，都会发现原来还有好多好多情况没有考虑清楚，简单来说就是经验不够丰富。现在项目的资源管理模块可以说是没有真正的管理好，导致AssetBundle在卸载时调用Unload(true)会出现资源丢失的情况。虽然找到了原因，但是改起来变得很难下手，代码的结构也因为反复修改补丁无数，变得越来越难维护。在任何一个Unity项目中都会涉及到资源的加载，特别是游戏行业，AssetBundle的资源加载可以说是必带的，要热更新嘛。


目前水平也有限，设计的结构可能不是很好，也不是很易懂易操作的，我先说说我的设计思路。

最近看Shader相关知识，接触最多的就是GPU流水线的工作形式了。<br/>

我也就按照自己的想法，乱写了一通，也算不上正规流水线，但是整个思考过程如下，肯定有待改进。<br/>

首先，需要一个流程发起模块，ResourceManager类，提供一个加载资源的接口给用户<br/>

然后，加载资源接口调用时(<font color="#FF0000">购物下单</font>)，注册回调(<font color="#FF0000">用户填写收货地址</font>)，会创建一个RefAsset(<font color="#FF0000">一个空的箱子</font>)<br/>

箱子创建后，开始进入工厂加工，进入整个流水线的LoaderManager(<font color="#FF0000">传送履带</font>)管理者来掌控<br/>

要给箱子装东西时，发现没有原材料，需要让AssetBundleManager(<font color="#FF0000">工厂内自动加载原材料的机器</font>)开始去加载RefAssetBundle(<font color="#FF0000">原材料</font>)<br/>

在获取到AssetBundle后，箱子进入下一个环节等待从RefAssetBundle中取出Prefab(<font color="#FF0000">传送履带把箱子挪到接受原材料加工的地方，等待原材料加工</font>)<br/>

Prefab取出后，会放入RefAsset中，RefAsset会准备调用用户注册的回调函数(<font color="#FF0000">进行封箱操作，放入快递车上，等待送达</font>)<br/>

用户拿到RefAsset后，可以选择自己是否要保留RefAsset的核心内容Prefab(<font color="#FF0000">收到快递后，顾客选择是否拿走箱子里的材料</font>)<br/>

用户把RefAsset内的Prefab使用时会自动加上AssetTracker(当使用箱子里面的材料时，就被追踪器顶上了)，并且不自己持有Prefab(<font color="#FF0000">箱子会回收到工厂内，并且会记录了此商品被使用过1次</font>)<br/>

用户把RefAsset内的Prefab自己持有，不还给管理者，以便于自己在其他时候进行实例化操作(<font color="#FF0000">箱子会回收到工厂内，其他用户需求同一个产品的时候，会指引到这个持有材料的用户上，实现的机制是依靠C#的弱引用功能来监控被拿走的材料是否还在被使用</font>)<br/>

当没有一个用户使用这个RefAsset实例化的对象，或者没有一个用户持有这个Prefab的时候，管理者就会进行清理操作，释放回收内存(<font color="#FF0000">定时清理不使用的箱子</font>)<br/>


-----------------------------------------------------------------------------------------------------------------<br/>
最后附上模块下载地址：
<a href="https://github.com/GodSeven7/UnityResourceManager">https://github.com/GodSeven7/UnityResourceManager</a>